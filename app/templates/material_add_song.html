{% extends "material_base.html" %}

{% block title %}Add New Song - LyraClipMAP{% endblock %}

{% block styles %}
.form-container {
    max-width: 800px;
    margin: 32px auto;
    padding: 0 16px;
}

.form-card {
    background-color: white;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    padding: 32px;
}

.form-title {
    font-size: 24px;
    font-weight: 500;
    margin: 0 0 8px 0;
    text-align: center;
}

.form-description {
    color: rgba(0,0,0,0.6);
    text-align: center;
    margin-bottom: 32px;
}

.form-group {
    margin-bottom: 24px;
}

.form-label {
    display: block;
    font-size: 14px;
    font-weight: 500;
    margin-bottom: 8px;
    color: rgba(0,0,0,0.6);
}

.form-input {
    width: 100%;
    padding: 12px 16px;
    font-size: 16px;
    border: 1px solid rgba(0,0,0,0.2);
    border-radius: 4px;
    transition: border-color 0.3s, box-shadow 0.3s;
}

.form-input:focus {
    border-color: var(--md-primary-color);
    box-shadow: 0 0 0 2px rgba(98, 0, 238, 0.2);
    outline: none;
}

.form-textarea {
    min-height: 200px;
    resize: vertical;
}

.form-helper {
    font-size: 12px;
    color: rgba(0,0,0,0.6);
    margin-top: 4px;
}

.form-submit {
    display: flex;
    justify-content: center;
    margin-top: 32px;
}

.url-preview {
    margin-top: 8px;
    padding: 16px;
    background-color: #f5f5f5;
    border-radius: 4px;
    display: none;
}

.url-preview.active {
    display: flex;
    align-items: center;
}

.url-preview-thumbnail {
    width: 120px;
    height: 80px;
    background-color: #e0e0e0;
    margin-right: 16px;
    border-radius: 4px;
    flex-shrink: 0;
}

.url-preview-info {
    flex: 1;
}

.url-preview-title {
    font-weight: 500;
    margin: 0 0 4px 0;
}

.url-preview-channel {
    font-size: 14px;
    color: rgba(0,0,0,0.6);
    margin: 0;
}
{% endblock %}

{% block content %}
<div class="form-container">
    <div class="form-card">
        <h2 class="form-title">Add New Song</h2>
        <p class="form-description">Enter a YouTube URL and we'll try to find the song details automatically.</p>
        
        <form action="/add" method="POST" id="add-song-form">
            <div class="form-group">
                <label class="form-label" for="youtube_url">YouTube URL</label>
                <input type="text" class="form-input" id="youtube_url" name="youtube_url" 
                       placeholder="e.g., https://www.youtube.com/watch?v=dQw4w9WgXcQ" required>
                <p class="form-helper">Paste a YouTube video URL to automatically extract song information</p>
                
                <div class="url-preview" id="url-preview">
                    <div class="url-preview-thumbnail" id="preview-thumbnail"></div>
                    <div class="url-preview-info">
                        <h4 class="url-preview-title" id="preview-title">Video Title</h4>
                        <p class="url-preview-channel" id="preview-channel">Channel Name</p>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="title">Song Title</label>
                <input type="text" class="form-input" id="title" name="title" placeholder="Will be auto-detected if possible">
                <p class="form-helper">Optional - will try to detect from YouTube</p>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="artist">Artist Name</label>
                <input type="text" class="form-input" id="artist" name="artist" placeholder="Will be auto-detected if possible">
                <p class="form-helper">Optional - will try to detect from YouTube</p>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="lyrics">Lyrics</label>
                <textarea class="form-input form-textarea" id="lyrics" name="lyrics" 
                          placeholder="Will try to find automatically from tekstowo.pl"></textarea>
                <p class="form-helper">Optional - we'll try to find lyrics automatically</p>
            </div>
            
            <div class="form-submit">
                <button type="submit" class="md-button md-button--raised">
                    <span class="material-icons">add</span>
                    Add Song
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const urlInput = document.getElementById('youtube_url');
        const titleInput = document.getElementById('title');
        const artistInput = document.getElementById('artist');
        const urlPreview = document.getElementById('url-preview');
        const previewTitle = document.getElementById('preview-title');
        const previewChannel = document.getElementById('preview-channel');
        const previewThumbnail = document.getElementById('preview-thumbnail');
        
        let fetchTimeout = null;
        
        // Handle URL input changes
        urlInput.addEventListener('input', function() {
            // Clear any existing timeout
            if (fetchTimeout) {
                clearTimeout(fetchTimeout);
            }
            
            // Only fetch after user stops typing for 500ms
            fetchTimeout = setTimeout(function() {
                const youtubeUrl = urlInput.value.trim();
                
                if (youtubeUrl && (youtubeUrl.includes('youtube.com/watch?v=') || youtubeUrl.includes('youtu.be/'))) {
                    // Show loading state
                    urlPreview.classList.add('active');
                    previewTitle.textContent = "Loading...";
                    previewChannel.textContent = "";
                    previewThumbnail.style.backgroundColor = "#f0f0f0";
                    previewThumbnail.style.backgroundImage = "none";
                    
                    // Fetch video info via AJAX
                    fetch('/material/add', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify({
                            youtube_url: youtubeUrl
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            throw new Error(data.error);
                        }
                        
                        // Update preview
                        previewTitle.textContent = data.title || "Unknown Title";
                        previewChannel.textContent = data.channel_name || "Unknown Channel";
                        
                        if (data.thumbnail) {
                            previewThumbnail.style.backgroundImage = `url(${data.thumbnail})`;
                            previewThumbnail.style.backgroundSize = 'cover';
                            previewThumbnail.style.backgroundPosition = 'center';
                        }
                        
                        // Auto-fill form fields if they're empty
                        if (!titleInput.value && data.song_title) {
                            titleInput.value = data.song_title;
                        } else if (!titleInput.value && data.title) {
                            titleInput.value = data.title;
                        }
                        
                        if (!artistInput.value && data.artist) {
                            artistInput.value = data.artist;
                        } else if (!artistInput.value && data.channel_name) {
                            artistInput.value = data.channel_name;
                        }
                        
                        // Show preview
                        urlPreview.classList.add('active');
                    })
                    .catch(error => {
                        console.error('Error fetching video info:', error);
                        previewTitle.textContent = "Could not load video info";
                        previewChannel.textContent = "Please check the URL";
                    });
                } else {
                    // Hide preview for invalid URL
                    urlPreview.classList.remove('active');
                }
            }, 500);
        });
    });
</script>
{% endblock %}